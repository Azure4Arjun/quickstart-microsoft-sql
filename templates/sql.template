{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "This template deploys two Windows Server Failover Clustering (WSFC) and SQL Server AlwaysOn Availability Group nodes. This template is intended to be installed into an existing VPC that was built using the sample reference architecture titled: \"Implementing Active Directory Domain Services in the AWS Cloud\" **WARNING** This template creates Amazon EC2 Windows instance and related resources. You will be billed for the AWS resources used if you create a stack from this template. QS(0003)",
    "Parameters": {
        "ADServer1NetBIOSName": {
            "AllowedPattern": "[a-zA-Z0-9]+",
            "Default": "DC1",
            "Description": "NetBIOS name of the first Active Directory server (up to 15 characters)",
            "MaxLength": "15",
            "MinLength": "1",
            "Type": "String"
        },
        "ADServer1PrivateIP": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.0.10",
            "Description": "Fixed private IP for the first Active Directory server located in Availability Zone 1",
            "Type": "String"
        },
        "ADServer2NetBIOSName": {
            "AllowedPattern": "[a-zA-Z0-9]+",
            "Default": "DC2",
            "Description": "NetBIOS name of the second Active Directory server (up to 15 characters)",
            "MaxLength": "15",
            "MinLength": "1",
            "Type": "String"
        },
        "ADServer2PrivateIP": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.32.10",
            "Description": "Fixed private IP for the second Active Directory server located in Availability Zone 2",
            "Type": "String"
        },
        "DomainAdminPassword": {
            "AllowedPattern": "(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*",
            "Description": "Password for the domain admin user. Must be at least 8 characters containing letters, numbers and symbols",
            "MaxLength": "32",
            "MinLength": "8",
            "NoEcho": "true",
            "Type": "String"
        },
        "DomainAdminUser": {
            "AllowedPattern": "[a-zA-Z0-9]*",
            "Default": "StackAdmin",
            "Description": "User name for the account that will be used as Domain Administrator. This is separate from the default \"Administrator\" account",
            "MaxLength": "25",
            "MinLength": "5",
            "Type": "String"
        },
        "DomainDNSName": {
            "Description": "Fully qualified domain name (FQDN) e.g. example.com",
            "Type": "String",
            "Default": "example.com",
            "MinLength": "3",
            "MaxLength": "25",
            "AllowedPattern": "[a-zA-Z0-9]+\\..+"
        },
        "DomainMemberSGID": {
            "Description": "ID of the Domain Member Security Group (e.g., sg-7f16e910)",
            "Type": "AWS::EC2::SecurityGroup::Id"
        },
        "DomainNetBIOSName": {
            "AllowedPattern": "[a-zA-Z0-9]+",
            "Default": "EXAMPLE",
            "Description": "NetBIOS name of the domain (up to 15 characters) for users of earlier versions of Windows e.g. EXAMPLE",
            "MaxLength": "15",
            "MinLength": "1",
            "Type": "String"
        },
        "DedicatedHostAMI": {
            "Default": "",
            "Description": "If host type is set to \"Dedicated\" or \"Dedicated Host\", you need to specify your imported BYOL AMI id",
            "Type": "String"
        },
        "DedicatedHostIDNode1": {
            "Default": "",
            "Description": "Dedicated HostID for Node1, Only used if HostType is set to \"host\"",
            "Type": "String"
        },
        "DedicatedHostIDNode2": {
            "Default": "",
            "Description": "Dedicated HostID for Node2, Only used if HostType is set to \"host\"",
            "Type": "String"
        },
        "DedicatedHostIDNode3": {
            "Default": "",
            "Description": "Dedicated HostID for the optional Node3, Only used if HostType is set to \"host\"",
            "Type": "String"
        },
        "HostType": {
            "Default": "Shared",
            "AllowedValues": [
                "Shared",
                "Dedicated",
                "Dedicated Host"
            ],
            "Description": "Host Type, NB: For dedicated types, you must already have suitable dedicated hosts in your account",
            "Type": "String"
        },
        "KeyPairName": {
            "Description": "Public/private key pairs allow you to securely connect to your instance after it launches",
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "PrivateSubnet1CIDR": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Default": "10.0.0.0/19",
            "Description": "CIDR block for private subnet 1 located in Availability Zone 1.",
            "Type": "String"
        },
        "PrivateSubnet1ID": {
            "Description": "ID of the private subnet 1 in Availability Zone 1 (e.g., subnet-a0246dcd)",
            "Type": "AWS::EC2::Subnet::Id"
        },
        "PrivateSubnet2CIDR": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Default": "10.0.64.0/19",
            "Description": "CIDR block for private subnet 2 located in Availability Zone 2.",
            "Type": "String"
        },
        "PrivateSubnet2ID": {
            "Description": "ID of the private subnet 2 in Availability Zone 2 (e.g., subnet-a0246dcd)",
            "Type": "AWS::EC2::Subnet::Id"
        },
        "PrivateSubnet3CIDR": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Default": "10.0.64.0/19",
            "Description": "CIDR block for optional private subnet 3 located in Availability Zone 3.",
            "Type": "String"
        },
        "PrivateSubnet3ID": {
            "Default": "",
            "Description": "ID of the optional private subnet 3 in Availability Zone 3 (e.g., subnet-a0246dcd)",
            "Type": "String"
        },
        "QSS3BucketName": {
            "AllowedPattern": "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$",
            "ConstraintDescription": "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).",
            "Default": "quickstart-reference",
            "Description": "S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).",
            "Type": "String"
        },
        "QSS3KeyPrefix": {
            "AllowedPattern": "^[0-9a-zA-Z-]+(/[0-9a-zA-Z-]+)*$",
            "ConstraintDescription": "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/). It cannot start or end with forward slash (/) because they are automatically appended.",
            "Default": "microsoft/sql/latest",
            "Description": "S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/). It cannot start or end with forward slash (/) because they are automatically appended.",
            "Type": "String"
        },
        "SQLLicenseProvided": {
            "AllowedValues": [
                "yes",
                "no"
            ],
            "Default": "no",
            "Description": "License SQL Server from AWS Marketplace. Note: this is only available for SQL 2014 and 2016, in us-east-1, us-west-2 and eu-west-1 regions and limits instance type to r3.2xlarge, r3.4xlarge and r3.8xlarge",
            "Type": "String"
        },
        "SQLServerVersion": {
            "AllowedValues": [
                "2016",
                "2014",
                "2012"
            ],
            "Default": "2014",
            "Description": "Version of SQL Server to install on WSFC Nodes. Options include either \"2014\" or \"2012\"",
            "Type": "String"
        },
        "SQLServiceAccount": {
            "AllowedPattern": "[a-zA-Z0-9]*",
            "Default": "sqlsa",
            "Description": "User name for the SQL Server Service Account. This Account is a Domain User.",
            "MaxLength": "25",
            "MinLength": "5",
            "Type": "String"
        },
        "SQLServiceAccountPassword": {
            "AllowedPattern": "(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*",
            "Description": "Password for the SQL Service account. Must be at least 8 characters containing letters, numbers and symbols",
            "MaxLength": "32",
            "MinLength": "8",
            "NoEcho": "true",
            "Type": "String"
        },
        "ThirdAz": {
            "Default": "no",
            "AllowedValues": [
                "no",
                "witness",
                "full"
            ],
            "Description": "Enable a 3 AZ deployment, the 3rd AZ can either be used just for the witness, or can be a full SQL cluster node.",
            "Type": "String"
        },
        "Volume1Iops": {
            "Default": "1000",
            "MinValue": "100",
            "MaxValue": "20000",
            "Description": "Iops for the SQL Data drive (Only used when volume type is io1)",
            "Type": "Number"
        },
        "Volume1Size": {
            "Default": "500",
            "MinValue": "100",
            "MaxValue": "16000",
            "Description": "Volume size for the SQL Data drive",
            "Type": "Number"
        },
        "Volume1Type": {
            "Default": "gp2",
            "AllowedValues": [
                "gp2",
                "io1"
            ],
            "Description": "Volume type for the SQL Data drive",
            "Type": "String"
        },
        "Volume2Iops": {
            "Default": "1000",
            "MinValue": "100",
            "MaxValue": "20000",
            "Description": "Iops for the SQL Logs drive (Only used when volume type is io1)",
            "Type": "Number"
        },
        "Volume2Size": {
            "Default": "500",
            "MinValue": "100",
            "MaxValue": "16000",
            "Description": "Volume size for the SQL Logs drive",
            "Type": "Number"
        },
        "Volume2Type": {
            "Default": "gp2",
            "AllowedValues": [
                "gp2",
                "io1"
            ],
            "Description": "Volume type for the SQL Logs drive",
            "Type": "String"
        },
        "Volume3Iops": {
            "Default": "1000",
            "MinValue": "100",
            "MaxValue": "20000",
            "Description": "Iops for the SQL TempDB drive (Only used when volume type is io1)",
            "Type": "Number"
        },
        "Volume3Size": {
            "Default": "500",
            "MinValue": "100",
            "MaxValue": "16000",
            "Description": "Volume size for the SQL TempDB drive",
            "Type": "Number"
        },
        "Volume3Type": {
            "Default": "gp2",
            "AllowedValues": [
                "gp2",
                "io1"
            ],
            "Description": "Volume type for the SQL TempDB drive",
            "Type": "String"
        },
        "VPCCIDR": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Default": "10.0.0.0/16",
            "Description": "CIDR Block for the VPC",
            "Type": "String"
        },
        "VPCID": {
            "Description": "ID of the VPC (e.g., vpc-0343606e)",
            "Type": "AWS::EC2::VPC::Id"
        },
        "WSFCFileServerInstanceType": {
            "Default": "t2.small",
            "Description": "Amazon EC2 instance type for a fileserver used to share install media, witness and replication folders",
            "Type": "String"
        },
        "WSFCFileServerPrivateIP": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.0.200",
            "Description": "Primary private IP for the fileserver located in Availability Zone 1",
            "Type": "String"
        },
        "WSFCFileServerNetBIOSName": {
            "AllowedPattern": "[a-zA-Z0-9]+",
            "Default": "WSFCFileServer",
            "Description": "NetBIOS name of the WSFCFileServer (up to 15 characters)",
            "MaxLength": "15",
            "MinLength": "1",
            "Type": "String"
        },
        "WSFCNode1InstanceType": {
            "AllowedValues": [
                "r3.xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge"
            ],
            "ConstraintDescription": "Only EBS Optimized instance types r3.xlarge, r3.2xlarge, r3.4xlarge, r3.8xlarge allowed",
            "Default": "r3.2xlarge",
            "Description": "Amazon EC2 instance type for the first WSFC Node",
            "Type": "String"
        },
        "WSFCNode1NetBIOSName": {
            "AllowedPattern": "[a-zA-Z0-9]+",
            "Default": "WSFCNode1",
            "Description": "NetBIOS name of the first WSFC Node (up to 15 characters)",
            "MaxLength": "15",
            "MinLength": "1",
            "Type": "String"
        },
        "WSFCNode1PrivateIP1": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.0.100",
            "Description": "Primary private IP for the first WSFC Node located in Availability Zone 1",
            "Type": "String"
        },
        "WSFCNode1PrivateIP2": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.0.101",
            "Description": "Secondary private IP for WSFC cluster on first WSFC Node",
            "Type": "String"
        },
        "WSFCNode1PrivateIP3": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.0.102",
            "Description": "Third private IP for Availability Group Listener on first WSFC Node",
            "Type": "String"
        },
        "WSFCNode2InstanceType": {
            "AllowedValues": [
                "r3.xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge"
            ],
            "ConstraintDescription": "Only EBS Optimized instance types r3.xlarge, r3.2xlarge, r3.4xlarge, r3.8xlarge allowed",
            "Default": "r3.2xlarge",
            "Description": "Amazon EC2 instance type for the second WSFC Node",
            "Type": "String"
        },
        "WSFCNode2NetBIOSName": {
            "AllowedPattern": "[a-zA-Z0-9]+",
            "Default": "WSFCNode2",
            "Description": "NetBIOS name of the second WSFC Node (up to 15 characters)",
            "MaxLength": "15",
            "MinLength": "1",
            "Type": "String"
        },
        "WSFCNode2PrivateIP1": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.32.100",
            "Description": "Primary private IP for the second WSFC Node located in Availability Zone 2",
            "Type": "String"
        },
        "WSFCNode2PrivateIP2": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.32.101",
            "Description": "Secondary private IP for WSFC cluster on second WSFC Node",
            "Type": "String"
        },
        "WSFCNode2PrivateIP3": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.64.102",
            "Description": "Third private IP for Availability Group Listener on second WSFC Node",
            "Type": "String"
        },
        "WSFCNode3InstanceType": {
            "AllowedValues": [
                "r3.xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge"
            ],
            "ConstraintDescription": "Only EBS Optimized instance types r3.xlarge, r3.2xlarge, r3.4xlarge, r3.8xlarge allowed",
            "Default": "r3.2xlarge",
            "Description": "Amazon EC2 instance type for the second WSFC Node",
            "Type": "String"
        },
        "WSFCNode3NetBIOSName": {
            "AllowedPattern": "[a-zA-Z0-9]+",
            "Default": "WSFCNode3",
            "Description": "NetBIOS name of the second WSFC Node (up to 15 characters)",
            "MaxLength": "15",
            "MinLength": "1",
            "Type": "String"
        },
        "WSFCNode3PrivateIP1": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.64.100",
            "Description": "Primary private IP for the optional third WSFC Node located in Availability Zone 3",
            "Type": "String"
        },
        "WSFCNode3PrivateIP2": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.64.101",
            "Description": "Secondary private IP for WSFC cluster on optional third WSFC Node",
            "Type": "String"
        },
        "WSFCNode3PrivateIP3": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.64.102",
            "Description": "Third private IP for Availability Group Listener on optional third WSFC Node",
            "Type": "String"
        }
    },
    "Conditions": {
        "IsThreeAz": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ThirdAz"
                        },
                        "no"
                    ]
                }
            ]
        },
        "ThirdAzIsWitness": {
            "Fn::Equals": [
                {
                    "Ref": "ThirdAz"
                },
                "witness"
            ]
        },
        "ThirdAzIsFullNode": {
            "Fn::Equals": [
                {
                    "Ref": "ThirdAz"
                },
                "full"
            ]
        },
        "IsTwoNode": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ThirdAz"
                        },
                        "full"
                    ]
                }
            ]
        },
        "Vol1IsIo1": {
            "Fn::Equals": [
                {
                    "Ref": "Volume1Type"
                },
                "io1"
            ]
        },
        "Vol2IsIo1": {
            "Fn::Equals": [
                {
                    "Ref": "Volume1Type"
                },
                "io1"
            ]
        },
        "Vol3IsIo1": {
            "Fn::Equals": [
                {
                    "Ref": "Volume1Type"
                },
                "io1"
            ]
        },
        "HostTypeIsDefault": {
            "Fn::Equals": [
                {
                    "Ref": "HostType"
                },
                "Shared"
            ]
        },
        "HostTypeIsDediHost": {
            "Fn::Equals": [
                {
                    "Ref": "HostType"
                },
                "Dedicated Host"
            ]
        },
        "ByolAmi": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "HostType"
                        },
                        "Shared"
                    ]
                }
            ]
        },
        "SQLBakedInAMI": {
            "Fn::Equals": [
                {
                    "Ref": "SQLLicenseProvided"
                },
                "yes"
            ]
        }
    },
    "Rules": {
        "SubnetsInVPC": {
            "Assertions": [
                {
                    "Assert": {
                        "Fn::EachMemberIn": [
                            {
                                "Fn::ValueOfAll": [
                                    "AWS::EC2::Subnet::Id",
                                    "VpcId"
                                ]
                            },
                            {
                                "Fn::RefAll": "AWS::EC2::VPC::Id"
                            }
                        ]
                    },
                    "AssertDescription": "All subnets must in the VPC"
                }
            ]
        }
    },
    "Mappings": {
        "AWSAMIRegionMap": {
            "AMI": {
                "WS2012R2": "Windows_Server-2012-R2_RTM-English-64Bit-Base-2016.11.09",
                "WS2012R2SQLENT2014": "Windows_Server-2012-R2_RTM-English-64Bit-SQL_2014_SP1_Enterprise-2016.11.09",
                "WS2012R2SQLENT2016": "Windows_Server-2012-R2_RTM-English-64Bit-SQL_2016_Enterprise-2016.11.09"
            },
            "ap-northeast-1": {
                "WS2012R2": "ami-b779d3d6",
                "WS2012R2SQLENT2014": "ami-fc7ed49d",
                "WS2012R2SQLENT2016": "ami-627fd503"
            },
            "ap-northeast-2": {
                "WS2012R2": "ami-b08b5cde",
                "WS2012R2SQLENT2014": "ami-7f895e11",
                "WS2012R2SQLENT2016": "ami-72b7601c"
            },
            "ap-south-1": {
                "WS2012R2": "ami-14dca87b",
                "WS2012R2SQLENT2014": "ami-12dca87d",
                "WS2012R2SQLENT2016": "ami-bbc0b4d4"
            },
            "ap-southeast-1": {
                "WS2012R2": "ami-b1e240d2",
                "WS2012R2SQLENT2014": "ami-b9e240da",
                "WS2012R2SQLENT2016": "ami-fc1cbf9f"
            },
            "ap-southeast-2": {
                "WS2012R2": "ami-16645a75",
                "WS2012R2SQLENT2014": "ami-5e655b3d",
                "WS2012R2SQLENT2016": "ami-52655b31"
            },
            "eu-central-1": {
                "WS2012R2": "ami-c208cdad",
                "WS2012R2SQLENT2014": "ami-360bce59",
                "WS2012R2SQLENT2016": "ami-500acf3f"
            },
            "eu-west-1": {
                "WS2012R2": "ami-d8d586ab",
                "WS2012R2SQLENT2014": "ami-6dd5861e",
                "WS2012R2SQLENT2016": "ami-06d58675"
            },
            "sa-east-1": {
                "WS2012R2": "ami-b91c83d5",
                "WS2012R2SQLENT2014": "ami-ca2db2a6",
                "WS2012R2SQLENT2016": "ami-c92db2a5"
            },
            "us-east-1": {
                "WS2012R2": "ami-83d2f894",
                "WS2012R2SQLENT2014": "ami-59d2f84e",
                "WS2012R2SQLENT2016": "ami-d4d2f8c3"
            },
            "us-east-2": {
                "WS2012R2": "ami-1d752f78",
                "WS2012R2SQLENT2014": "ami-ed623888",
                "WS2012R2SQLENT2016": "ami-13693376"
            },
            "us-west-1": {
                "WS2012R2": "ami-b1c792d1",
                "WS2012R2SQLENT2014": "ami-6fc7920f",
                "WS2012R2SQLENT2016": "ami-efc7928f"
            },
            "us-west-2": {
                "WS2012R2": "ami-1c7ad77c",
                "WS2012R2SQLENT2014": "ami-aa74d9ca",
                "WS2012R2SQLENT2016": "ami-8d78d5ed"
            }
        },
        "AWSInfoRegionMap": {
            "ap-northeast-1": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "ap-northeast-2": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "ap-south-1": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "ap-southeast-1": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "ap-southeast-2": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "eu-central-1": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "eu-west-1": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "sa-east-1": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "us-east-1": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "us-east-2": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "us-gov-west-1": {
                "Partition": "aws-us-gov",
                "QuickStartS3URL": "https://s3-us-gov-west-1.amazonaws.com"
            },
            "us-west-1": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            },
            "us-west-2": {
                "Partition": "aws",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            }
        },
        "SQLAMINameMap": {
            "2012": {
                "no": "WS2012R2"
            },
            "2014": {
                "no": "WS2012R2",
                "yes": "WS2012R2SQLENT2014"
            },
            "2016": {
                "no": "WS2012R2",
                "yes": "WS2012R2SQLENT2016"
            }
        }
    },
    "Resources": {
        "WSFCFileServerWaitCondition": {
            "Type": "AWS::CloudFormation::WaitCondition",
            "Condition": "IsTwoNode",
            "DependsOn": "WSFCFileServer",
            "Properties": {
                "Handle": {
                    "Ref": "WSFCFileServerWaitHandle"
                },
                "Timeout": "3600"
            }
        },
        "WSFCFileServerWaitHandle": {
            "Type": "AWS::CloudFormation::WaitConditionHandle"
        },
        "WSFCNode1WaitCondition": {
            "Type": "AWS::CloudFormation::WaitCondition",
            "DependsOn": "WSFCNode1",
            "Properties": {
                "Handle": {
                    "Ref": "WSFCNode1WaitHandle"
                },
                "Timeout": "3600"
            }
        },
        "WSFCNode1WaitHandle": {
            "Type": "AWS::CloudFormation::WaitConditionHandle"
        },
        "WSFCNode2WaitCondition": {
            "Type": "AWS::CloudFormation::WaitCondition",
            "DependsOn": "WSFCNode2",
            "Properties": {
                "Handle": {
                    "Ref": "WSFCNode2WaitHandle"
                },
                "Timeout": "3600"
            }
        },
        "WSFCNode2WaitHandle": {
            "Type": "AWS::CloudFormation::WaitConditionHandle"
        },
        "WSFCNode3WaitCondition": {
            "Type": "AWS::CloudFormation::WaitCondition",
            "Condition": "ThirdAzIsFullNode",
            "DependsOn": "WSFCNode3",
            "Properties": {
                "Handle": {
                    "Ref": "WSFCNode3WaitHandle"
                },
                "Timeout": "5400"
            }
        },
        "WSFCNode3WaitHandle": {
            "Condition": "ThirdAzIsFullNode",
            "Type": "AWS::CloudFormation::WaitConditionHandle"
        },
        "WSFCFileServer": {
            "Type": "AWS::EC2::Instance",
            "Condition": "IsTwoNode",
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "configSets": {
                        "config": [
                            "QuickStartSetup",
                            "Prep",
                            "Install",
                            "Configure",
                            "Cleanup",
                            "Finalize"
                        ]
                    },
                    "QuickStartSetup": {
                        "files": {
                            "c:\\cfn\\cfn-hup.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[main]\n",
                                            "stack=",
                                            {
                                                "Ref": "AWS::StackId"
                                            },
                                            "\n",
                                            "region=",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[cfn-auto-reloader-hook]\n",
                                            "triggers=post.update\n",
                                            "path=Resources.WSFCFileServer.Metadata.AWS::CloudFormation::Init\n",
                                            "action=cfn-init.exe -v -s ",
                                            {
                                                "Ref": "AWS::StackId"
                                            },
                                            " -r WSFCFileServer",
                                            " --region ",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Unzip-Archive.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Unzip-Archive.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\modules\\AWSQuickStart.zip": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "modules/AWSQuickStart.zip"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-execution-policy": {
                                "command": "powershell.exe -Command \"Set-ExecutionPolicy RemoteSigned -Force\"",
                                "waitAfterCompletion": "0"
                            },
                            "b-unpack-quickstart-module": {
                                "command": "powershell.exe -Command C:\\cfn\\scripts\\Unzip-Archive.ps1 -Source C:\\cfn\\modules\\AWSQuickStart.zip -Destination C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\Modules\\",
                                "waitAfterCompletion": "0"
                            },
                            "c-init-quickstart-module": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"",
                                            "New-AWSQuickStartWaitHandle -Handle '",
                                            {
                                                "Ref": "WSFCFileServerWaitHandle"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        },
                        "services": {
                            "windows": {
                                "cfn-hup": {
                                    "enabled": "true",
                                    "ensureRunning": "true",
                                    "files": [
                                        "C:\\cfn\\cfn-hup.conf",
                                        "C:\\cfn\\hooks.d\\cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        }
                    },
                    "Prep": {
                        "files": {
                            "C:\\cfn\\scripts\\Set-Dns.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Set-Dns.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Join-Domain.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Join-Domain.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Rename-Computer.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Rename-Computer.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Create-Share.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Create-Share.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Create-ADServiceAccount.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Create-ADServiceAccount.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\AddUserToGroup.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/AddUserToGroup.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Invoke-ADReplication.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Invoke-ADReplication.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-dns": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Set-Dns.ps1 -ns1 '",
                                            {
                                                "Ref": "ADServer1PrivateIP"
                                            },
                                            "' -ns2 '",
                                            {
                                                "Ref": "ADServer2PrivateIP"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "30"
                            },
                            "b-rename-computer": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Rename-Computer.ps1 -Restart -NewName '",
                                            {
                                                "Ref": "WSFCFileServerNetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            },
                            "c-join-domain": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Join-Domain.ps1 -DomainName '",
                                            {
                                                "Ref": "DomainDNSName"
                                            },
                                            "' -UserName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "\\",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            },
                            "d-create-sql-account": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Create-ADServiceAccount.ps1 -DomainDNSName '",
                                            {
                                                "Ref": "DomainDNSName"
                                            },
                                            "' -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -ServiceAccountUser '",
                                            {
                                                "Ref": "SQLServiceAccount"
                                            },
                                            "' -ServiceAccountPassword '",
                                            {
                                                "Ref": "SQLServiceAccountPassword"
                                            },
                                            "' -ADServerNetBIOSName '",
                                            {
                                                "Ref": "ADServer1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "e-Invoke-ADReplication-DC1": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Invoke-ADReplication.ps1",
                                            " -UserName '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -DomainController '",
                                            {
                                                "Ref": "ADServer1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "f-Invoke-ADReplication-DC2": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Invoke-ADReplication.ps1",
                                            " -UserName '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -DomainController '",
                                            {
                                                "Ref": "ADServer2NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "15"
                            },
                            "g-add-domadmin-user-to-group": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-ExecutionPolicy RemoteSigned ",
                                            "-Command \"",
                                            " C:\\cfn\\scripts\\AddUserToGroup.ps1 -UserName '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -ServerName '",
                                            {
                                                "Ref": "WSFCFileServerNetBIOSName"
                                            },
                                            "' -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -GroupName 'Administrators'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "h-add-sqlservice-user-to-group": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-ExecutionPolicy RemoteSigned ",
                                            "-Command \"",
                                            "C:\\cfn\\scripts\\AddUserToGroup.ps1 -UserName '",
                                            {
                                                "Ref": "SQLServiceAccount"
                                            },
                                            "' -ServerName '",
                                            {
                                                "Ref": "WSFCFileServerNetBIOSName"
                                            },
                                            "' -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -GroupName 'Administrators'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Install": {},
                    "Configure": {},
                    "Cleanup": {},
                    "Finalize": {
                        "commands": {
                            "a-signal-success": {
                                "command": "powershell -Command \"Write-AWSQuickStartStatus\""
                            }
                        }
                    }
                }
            },
            "Properties": {
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSAMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "WS2012R2"
                    ]
                },
                "InstanceType": {
                    "Ref": "WSFCFileServerInstanceType"
                },
                "NetworkInterfaces": [
                    {
                        "DeleteOnTermination": "true",
                        "DeviceIndex": 0,
                        "SubnetId": {
                            "Fn::If": [
                                "ThirdAzIsWitness",
                                {
                                    "Ref": "PrivateSubnet3ID"
                                },
                                {
                                    "Ref": "PrivateSubnet1ID"
                                }
                            ]
                        },
                        "PrivateIpAddresses": [
                            {
                                "Primary": "true",
                                "PrivateIpAddress": {
                                    "Ref": "WSFCFileServerPrivateIP"
                                }
                            }
                        ],
                        "GroupSet": [
                            {
                                "Ref": "DomainMemberSGID"
                            },
                            {
                                "Ref": "WSFCSecurityGroup"
                            },
                            {
                                "Ref": "WSFCClientSecurityGroup"
                            }
                        ]
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "WSFCFileServerNetBIOSName"
                        }
                    }
                ],
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "100",
                            "VolumeType": "gp2"
                        }
                    }
                ],
                "KeyName": {
                    "Ref": "KeyPairName"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "<script>\n",
                                "cfn-init.exe -v -c config -s ",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                " -r WSFCFileServer ",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "</script>"
                            ]
                        ]
                    }
                }
            }
        },
        "WSFCNode1": {
            "Type": "AWS::EC2::Instance",
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "configSets": {
                        "config": [
                            "QuickStartSetup",
                            "Prep",
                            {
                                "Fn::If": [
                                    "SQLBakedInAMI",
                                    "SQLIncludedConfigure",
                                    "Install"
                                ]
                            },
                            "Configure",
                            "Cleanup",
                            "Finalize"
                        ]
                    },
                    "QuickStartSetup": {
                        "files": {
                            "c:\\cfn\\cfn-hup.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[main]\n",
                                            "stack=",
                                            {
                                                "Ref": "AWS::StackId"
                                            },
                                            "\n",
                                            "region=",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[cfn-auto-reloader-hook]\n",
                                            "triggers=post.update\n",
                                            "path=Resources.WSFCNode1.Metadata.AWS::CloudFormation::Init\n",
                                            "action=cfn-init.exe -v -s ",
                                            {
                                                "Ref": "AWS::StackId"
                                            },
                                            " -r WSFCNode1",
                                            " --region ",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Unzip-Archive.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Unzip-Archive.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\modules\\AWSQuickStart.zip": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "modules/AWSQuickStart.zip"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-execution-policy": {
                                "command": "powershell.exe -Command \"Set-ExecutionPolicy RemoteSigned -Force\"",
                                "waitAfterCompletion": "0"
                            },
                            "b-unpack-quickstart-module": {
                                "command": "powershell.exe -Command C:\\cfn\\scripts\\Unzip-Archive.ps1 -Source C:\\cfn\\modules\\AWSQuickStart.zip -Destination C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\Modules\\",
                                "waitAfterCompletion": "0"
                            },
                            "c-init-quickstart-module": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"",
                                            "New-AWSQuickStartWaitHandle -Handle '",
                                            {
                                                "Ref": "WSFCNode1WaitHandle"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        },
                        "services": {
                            "windows": {
                                "cfn-hup": {
                                    "enabled": "true",
                                    "ensureRunning": "true",
                                    "files": [
                                        "C:\\cfn\\cfn-hup.conf",
                                        "C:\\cfn\\hooks.d\\cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        }
                    },
                    "Prep": {
                        "files": {
                            "C:\\cfn\\scripts\\Set-Dns.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Set-Dns.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Join-Domain.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Join-Domain.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Rename-Computer.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Rename-Computer.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Install-WindowsFailoverClustering.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Install-WindowsFailoverClustering.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Install-NETFrameworkCore.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Install-NETFrameworkCore.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\OpenWSFCPorts.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/OpenWSFCPorts.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\EnableCredSsp.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/EnableCredSsp.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\DownloadSQLEE.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/DownloadSQLEE.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Create-ADServiceAccount.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Create-ADServiceAccount.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\AddUserToGroup.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/AddUserToGroup.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Invoke-ADReplication.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Invoke-ADReplication.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-dns": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Set-Dns.ps1 -ns1 '",
                                            {
                                                "Ref": "ADServer1PrivateIP"
                                            },
                                            "' -ns2 '",
                                            {
                                                "Ref": "ADServer2PrivateIP"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "30"
                            },
                            "b-rename-computer": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Rename-Computer.ps1 -Restart -NewName '",
                                            {
                                                "Ref": "WSFCNode1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            },
                            "c-join-domain": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Join-Domain.ps1 -DomainName '",
                                            {
                                                "Ref": "DomainDNSName"
                                            },
                                            "' -UserName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "\\",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            },
                            "d-install-net-framework-core": {
                                "command": "powershell.exe -Command \"C:\\cfn\\scripts\\Install-NETFrameworkCore.ps1\"",
                                "waitAfterCompletion": "0"
                            },
                            "e-install-windows-failover-clustering": {
                                "command": "powershell.exe -Command \"C:\\cfn\\scripts\\Install-WindowsFailoverClustering.ps1\"",
                                "waitAfterCompletion": "0"
                            },
                            "f-reboot": {
                                "command": "powershell.exe -Command \"Restart-Computer -Force\"",
                                "waitAfterCompletion": "forever"
                            },
                            "g-open-WSFC-ports": {
                                "command": "powershell.exe -ExecutionPolicy RemoteSigned -Command \"C:\\cfn\\scripts\\OpenWSFCPorts.ps1\"",
                                "waitAfterCompletion": "0"
                            },
                            "h-enable-credssp": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -ExecutionPolicy RemoteSigned -Command \"C:\\cfn\\scripts\\EnableCredSsp.ps1",
                                            " -DomainDNSName '",
                                            {
                                                "Ref": "DomainDNSName"
                                            },
                                            "' -ServerName '",
                                            {
                                                "Ref": "WSFCNode1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "i-create-sql-account": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Create-ADServiceAccount.ps1 -DomainDNSName '",
                                            {
                                                "Ref": "DomainDNSName"
                                            },
                                            "' -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -ServiceAccountUser '",
                                            {
                                                "Ref": "SQLServiceAccount"
                                            },
                                            "' -ServiceAccountPassword '",
                                            {
                                                "Ref": "SQLServiceAccountPassword"
                                            },
                                            "' -ADServerNetBIOSName '",
                                            {
                                                "Ref": "ADServer1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "j-Invoke-ADReplication-DC1": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Invoke-ADReplication.ps1",
                                            " -UserName '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -DomainController '",
                                            {
                                                "Ref": "ADServer1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "k-Invoke-ADReplication-DC2": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Invoke-ADReplication.ps1",
                                            " -UserName '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -DomainController '",
                                            {
                                                "Ref": "ADServer2NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "15"
                            },
                            "l-add-domadmin-user-to-group": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-ExecutionPolicy RemoteSigned ",
                                            "-Command \"",
                                            " C:\\cfn\\scripts\\AddUserToGroup.ps1 -UserName '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -ServerName '",
                                            {
                                                "Ref": "WSFCNode1NetBIOSName"
                                            },
                                            "' -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -GroupName 'Administrators'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "m-add-sqlservice-user-to-group": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-ExecutionPolicy RemoteSigned ",
                                            "-Command \"",
                                            "C:\\cfn\\scripts\\AddUserToGroup.ps1 -UserName '",
                                            {
                                                "Ref": "SQLServiceAccount"
                                            },
                                            "' -ServerName '",
                                            {
                                                "Ref": "WSFCNode1NetBIOSName"
                                            },
                                            "' -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -GroupName 'Administrators'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "n-download-sql-installer": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-ExecutionPolicy RemoteSigned ",
                                            "-Command \"",
                                            " C:\\cfn\\scripts\\DownloadSQLEE.ps1 -SQLServerVersion '",
                                            {
                                                "Ref": "SQLServerVersion"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Install": {
                        "files": {
                            "C:\\cfn\\scripts\\InstallSQLEE.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/InstallSQLEE.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-install-sql": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\InstallSQLEE.ps1 -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -SQLServiceAccount '",
                                            {
                                                "Ref": "SQLServiceAccount"
                                            },
                                            "' -SQLServiceAccountPassword '",
                                            {
                                                "Ref": "SQLServiceAccountPassword"
                                            },
                                            "' -NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "SQLIncludedConfigure": {
                        "files": {
                            "C:\\cfn\\scripts\\Reconfigure-SQL.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Reconfigure-SQL.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-configure-sql": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Reconfigure-SQL.ps1 -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -SQLServiceAccount '",
                                            {
                                                "Ref": "SQLServiceAccount"
                                            },
                                            "' -SQLServiceAccountPassword '",
                                            {
                                                "Ref": "SQLServiceAccountPassword"
                                            },
                                            "' -NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Configure": {
                        "files": {
                            "C:\\cfn\\scripts\\SetMaxDOP.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/SetMaxDOP.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-maxdop": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\SetMaxDOP.ps1 -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Cleanup": {
                        "files": {
                            "C:\\cfn\\scripts\\DisableCredSsp.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/DisableCredSsp.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-disable-credssp": {
                                "command": "powershell.exe -ExecutionPolicy RemoteSigned -Command \"C:\\cfn\\scripts\\DisableCredSsp.ps1\"",
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Finalize": {
                        "commands": {
                            "a-reboot": {
                                "command": "powershell.exe -Command \"Restart-Computer -Force\"",
                                "waitAfterCompletion": "forever"
                            },
                            "b-signal-success": {
                                "command": "powershell -Command \"Write-AWSQuickStartStatus\""
                            }
                        }
                    }
                }
            },
            "Properties": {
                "Affinity": {
                    "Fn::If": [
                        "HostTypeIsDediHost",
                        "host",
                        {
                            "Fn::If": [
                                "HostTypeIsDefault",
                                {
                                    "Ref": "AWS::NoValue"
                                },
                                "default"
                            ]
                        }
                    ]
                },
                "HostId": {
                    "Fn::If": [
                        "HostTypeIsDediHost",
                        {
                            "Ref": "DedicatedHostIDNode1"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Tenancy": {
                    "Fn::If": [
                        "HostTypeIsDediHost",
                        "host",
                        {
                            "Fn::If": [
                                "HostTypeIsDefault",
                                "default",
                                "dedicated"
                            ]
                        }
                    ]
                },
                "ImageId": {
                    "Fn::If": [
                        "ByolAmi",
                        {
                            "Ref": "DedicatedHostAMI"
                        },
                        {
                            "Fn::FindInMap": [
                                "AWSAMIRegionMap",
                                {
                                    "Ref": "AWS::Region"
                                },
                                {
                                    "Fn::FindInMap": [
                                        "SQLAMINameMap",
                                        {
                                            "Ref": "SQLServerVersion"
                                        },
                                        {
                                            "Ref": "SQLLicenseProvided"
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "InstanceType": {
                    "Ref": "WSFCNode1InstanceType"
                },
                "EbsOptimized": "true",
                "NetworkInterfaces": [
                    {
                        "DeleteOnTermination": "true",
                        "DeviceIndex": 0,
                        "SubnetId": {
                            "Ref": "PrivateSubnet1ID"
                        },
                        "PrivateIpAddresses": [
                            {
                                "Primary": "true",
                                "PrivateIpAddress": {
                                    "Ref": "WSFCNode1PrivateIP1"
                                }
                            },
                            {
                                "Primary": "false",
                                "PrivateIpAddress": {
                                    "Ref": "WSFCNode1PrivateIP2"
                                }
                            },
                            {
                                "Primary": "false",
                                "PrivateIpAddress": {
                                    "Ref": "WSFCNode1PrivateIP3"
                                }
                            }
                        ],
                        "GroupSet": [
                            {
                                "Ref": "DomainMemberSGID"
                            },
                            {
                                "Ref": "WSFCSecurityGroup"
                            },
                            {
                                "Ref": "WSFCClientSecurityGroup"
                            }
                        ]
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "WSFCNode1NetBIOSName"
                        }
                    }
                ],
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "100",
                            "VolumeType": "gp2"
                        }
                    },
                    {
                        "DeviceName": "/dev/xvdca",
                        "VirtualName": "ephemeral0"
                    }
                ],
                "KeyName": {
                    "Ref": "KeyPairName"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "<script>\n",
                                "cfn-init.exe -v -c config -s ",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                " -r WSFCNode1 ",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "</script>"
                            ]
                        ]
                    }
                }
            }
        },
        "WSFCNode3": {
            "Type": "AWS::EC2::Instance",
            "Condition": "ThirdAzIsFullNode",
            "DependsOn": "WSFCNode1WaitCondition",
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "configSets": {
                        "config": [
                            "QuickStartSetup",
                            "Prep",
                            {
                                "Fn::If": [
                                    "SQLBakedInAMI",
                                    "SQLIncludedConfigure",
                                    "Install"
                                ]
                            },
                            "Configure",
                            "Cleanup",
                            "Finalize"
                        ]
                    },
                    "QuickStartSetup": {
                        "files": {
                            "c:\\cfn\\cfn-hup.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[main]\n",
                                            "stack=",
                                            {
                                                "Ref": "AWS::StackId"
                                            },
                                            "\n",
                                            "region=",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[cfn-auto-reloader-hook]\n",
                                            "triggers=post.update\n",
                                            "path=Resources.WSFCNode3.Metadata.AWS::CloudFormation::Init\n",
                                            "action=cfn-init.exe -v -s ",
                                            {
                                                "Ref": "AWS::StackId"
                                            },
                                            " -r WSFCNode1",
                                            " --region ",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Unzip-Archive.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Unzip-Archive.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\modules\\AWSQuickStart.zip": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "modules/AWSQuickStart.zip"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-execution-policy": {
                                "command": "powershell.exe -Command \"Set-ExecutionPolicy RemoteSigned -Force\"",
                                "waitAfterCompletion": "0"
                            },
                            "b-unpack-quickstart-module": {
                                "command": "powershell.exe -Command C:\\cfn\\scripts\\Unzip-Archive.ps1 -Source C:\\cfn\\modules\\AWSQuickStart.zip -Destination C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\Modules\\",
                                "waitAfterCompletion": "0"
                            },
                            "c-init-quickstart-module": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"",
                                            "New-AWSQuickStartWaitHandle -Handle '",
                                            {
                                                "Ref": "WSFCNode3WaitHandle"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        },
                        "services": {
                            "windows": {
                                "cfn-hup": {
                                    "enabled": "true",
                                    "ensureRunning": "true",
                                    "files": [
                                        "C:\\cfn\\cfn-hup.conf",
                                        "C:\\cfn\\hooks.d\\cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        }
                    },
                    "Prep": {
                        "files": {
                            "C:\\cfn\\scripts\\Set-Dns.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Set-Dns.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Join-Domain.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Join-Domain.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Rename-Computer.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Rename-Computer.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Install-WindowsFailoverClustering.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Install-WindowsFailoverClustering.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Install-NETFrameworkCore.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Install-NETFrameworkCore.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\OpenWSFCPorts.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/OpenWSFCPorts.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\EnableCredSsp.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/EnableCredSsp.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\DownloadSQLEE.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/DownloadSQLEE.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Invoke-ADReplication.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Invoke-ADReplication.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-dns": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Set-Dns.ps1 -ns1 '",
                                            {
                                                "Ref": "ADServer1PrivateIP"
                                            },
                                            "' -ns2 '",
                                            {
                                                "Ref": "ADServer2PrivateIP"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "30"
                            },
                            "b-rename-computer": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Rename-Computer.ps1 -Restart -NewName '",
                                            {
                                                "Ref": "WSFCNode3NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            },
                            "c-join-domain": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Join-Domain.ps1 -DomainName '",
                                            {
                                                "Ref": "DomainDNSName"
                                            },
                                            "' -UserName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "\\",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            },
                            "d-install-net-framework-core": {
                                "command": "powershell.exe -Command \"C:\\cfn\\scripts\\Install-NETFrameworkCore.ps1\"",
                                "waitAfterCompletion": "0"
                            },
                            "e-install-windows-failover-clustering": {
                                "command": "powershell.exe -Command \"C:\\cfn\\scripts\\Install-WindowsFailoverClustering.ps1\"",
                                "waitAfterCompletion": "0"
                            },
                            "f-reboot": {
                                "command": "powershell.exe -Command \"Restart-Computer -Force\"",
                                "waitAfterCompletion": "forever"
                            },
                            "g-open-WSFC-ports": {
                                "command": "powershell.exe -ExecutionPolicy RemoteSigned -Command \"C:\\cfn\\scripts\\OpenWSFCPorts.ps1\"",
                                "waitAfterCompletion": "0"
                            },
                            "h-enable-credssp": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -ExecutionPolicy RemoteSigned -Command \"C:\\cfn\\scripts\\EnableCredSsp.ps1",
                                            " -DomainDNSName '",
                                            {
                                                "Ref": "DomainDNSName"
                                            },
                                            "' -ServerName '",
                                            {
                                                "Ref": "WSFCNode3NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "i-Invoke-ADReplication-DC1": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Invoke-ADReplication.ps1",
                                            " -UserName '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -DomainController '",
                                            {
                                                "Ref": "ADServer1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "j-Invoke-ADReplication-DC2": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Invoke-ADReplication.ps1",
                                            " -UserName '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -DomainController '",
                                            {
                                                "Ref": "ADServer2NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "15"
                            },
                            "k-download-sql-installer": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-ExecutionPolicy RemoteSigned ",
                                            "-Command \"",
                                            " C:\\cfn\\scripts\\DownloadSQLEE.ps1 -SQLServerVersion '",
                                            {
                                                "Ref": "SQLServerVersion"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Install": {
                        "files": {
                            "C:\\cfn\\scripts\\InstallSQLEE.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/InstallSQLEE.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-install-sql": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\InstallSQLEE.ps1 -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -SQLServiceAccount '",
                                            {
                                                "Ref": "SQLServiceAccount"
                                            },
                                            "' -SQLServiceAccountPassword '",
                                            {
                                                "Ref": "SQLServiceAccountPassword"
                                            },
                                            "' -NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode3NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "SQLIncludedConfigure": {
                        "files": {
                            "C:\\cfn\\scripts\\Reconfigure-SQL.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Reconfigure-SQL.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-configure-sql": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Reconfigure-SQL.ps1 -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -SQLServiceAccount '",
                                            {
                                                "Ref": "SQLServiceAccount"
                                            },
                                            "' -SQLServiceAccountPassword '",
                                            {
                                                "Ref": "SQLServiceAccountPassword"
                                            },
                                            "' -NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Configure": {
                        "files": {
                            "C:\\cfn\\scripts\\SetMaxDOP.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/SetMaxDOP.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-maxdop": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\SetMaxDOP.ps1 -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode3NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Cleanup": {
                        "files": {
                            "C:\\cfn\\scripts\\DisableCredSsp.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/DisableCredSsp.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-disable-credssp": {
                                "command": "powershell.exe -ExecutionPolicy RemoteSigned -Command \"C:\\cfn\\scripts\\DisableCredSsp.ps1\"",
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Finalize": {
                        "commands": {
                            "a-reboot": {
                                "command": "powershell.exe -Command \"Restart-Computer -Force\"",
                                "waitAfterCompletion": "forever"
                            },
                            "b-signal-success": {
                                "command": "powershell -Command \"Write-AWSQuickStartStatus\""
                            }
                        }
                    }
                }
            },
            "Properties": {
                "Affinity": {
                    "Fn::If": [
                        "HostTypeIsDediHost",
                        "host",
                        {
                            "Fn::If": [
                                "HostTypeIsDefault",
                                {
                                    "Ref": "AWS::NoValue"
                                },
                                "default"
                            ]
                        }
                    ]
                },
                "HostId": {
                    "Fn::If": [
                        "HostTypeIsDediHost",
                        {
                            "Ref": "DedicatedHostIDNode3"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Tenancy": {
                    "Fn::If": [
                        "HostTypeIsDediHost",
                        "host",
                        {
                            "Fn::If": [
                                "HostTypeIsDefault",
                                "default",
                                "dedicated"
                            ]
                        }
                    ]
                },
                "ImageId": {
                    "Fn::If": [
                        "ByolAmi",
                        {
                            "Ref": "DedicatedHostAMI"
                        },
                        {
                            "Fn::FindInMap": [
                                "AWSAMIRegionMap",
                                {
                                    "Ref": "AWS::Region"
                                },
                                {
                                    "Fn::FindInMap": [
                                        "SQLAMINameMap",
                                        {
                                            "Ref": "SQLServerVersion"
                                        },
                                        {
                                            "Ref": "SQLLicenseProvided"
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "InstanceType": {
                    "Ref": "WSFCNode3InstanceType"
                },
                "EbsOptimized": "true",
                "NetworkInterfaces": [
                    {
                        "DeleteOnTermination": "true",
                        "DeviceIndex": 0,
                        "SubnetId": {
                            "Ref": "PrivateSubnet3ID"
                        },
                        "PrivateIpAddresses": [
                            {
                                "Primary": "true",
                                "PrivateIpAddress": {
                                    "Ref": "WSFCNode3PrivateIP1"
                                }
                            },
                            {
                                "Primary": "false",
                                "PrivateIpAddress": {
                                    "Ref": "WSFCNode3PrivateIP2"
                                }
                            },
                            {
                                "Primary": "false",
                                "PrivateIpAddress": {
                                    "Ref": "WSFCNode3PrivateIP3"
                                }
                            }
                        ],
                        "GroupSet": [
                            {
                                "Ref": "DomainMemberSGID"
                            },
                            {
                                "Ref": "WSFCSecurityGroup"
                            },
                            {
                                "Ref": "WSFCClientSecurityGroup"
                            }
                        ]
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "WSFCNode3NetBIOSName"
                        }
                    }
                ],
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "100",
                            "VolumeType": "gp2"
                        }
                    },
                    {
                        "DeviceName": "/dev/xvdca",
                        "VirtualName": "ephemeral0"
                    }
                ],
                "KeyName": {
                    "Ref": "KeyPairName"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "<script>\n",
                                "cfn-init.exe -v -c config -s ",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                " -r WSFCNode3 ",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "</script>"
                            ]
                        ]
                    }
                }
            }
        },
        "WSFCNode2": {
            "Type": "AWS::EC2::Instance",
            "Metadata": {
                "PseudoDependsOn": {
                    "Fn::If": [
                        "IsTwoNode",
                        [
                            {
                                "Ref": "WSFCFileServerWaitCondition"
                            },
                            {
                                "Ref": "WSFCNode1WaitCondition"
                            }
                        ],
                        [
                            {
                                "Ref": "WSFCNode1WaitCondition"
                            },
                            {
                                "Ref": "WSFCNode3WaitCondition"
                            }
                        ]
                    ]
                },
                "AWS::CloudFormation::Init": {
                    "configSets": {
                        "config": [
                            "QuickStartSetup",
                            "Prep",
                            {
                                "Fn::If": [
                                    "SQLBakedInAMI",
                                    "SQLIncludedConfigure",
                                    "Install"
                                ]
                            },
                            "Configure",
                            "Cleanup",
                            "Finalize"
                        ]
                    },
                    "QuickStartSetup": {
                        "files": {
                            "c:\\cfn\\cfn-hup.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[main]\n",
                                            "stack=",
                                            {
                                                "Ref": "AWS::StackId"
                                            },
                                            "\n",
                                            "region=",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[cfn-auto-reloader-hook]\n",
                                            "triggers=post.update\n",
                                            "path=Resources.WSFCNode2.Metadata.AWS::CloudFormation::Init\n",
                                            "action=cfn-init.exe -v -s ",
                                            {
                                                "Ref": "AWS::StackId"
                                            },
                                            " -r WSFCNode2",
                                            " --region ",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Unzip-Archive.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Unzip-Archive.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\modules\\AWSQuickStart.zip": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "modules/AWSQuickStart.zip"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-execution-policy": {
                                "command": "powershell.exe -Command \"Set-ExecutionPolicy RemoteSigned -Force\"",
                                "waitAfterCompletion": "0"
                            },
                            "b-unpack-quickstart-module": {
                                "command": "powershell.exe -Command C:\\cfn\\scripts\\Unzip-Archive.ps1 -Source C:\\cfn\\modules\\AWSQuickStart.zip -Destination C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\Modules\\",
                                "waitAfterCompletion": "0"
                            },
                            "c-init-quickstart-module": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"",
                                            "New-AWSQuickStartWaitHandle -Handle '",
                                            {
                                                "Ref": "WSFCNode2WaitHandle"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        },
                        "services": {
                            "windows": {
                                "cfn-hup": {
                                    "enabled": "true",
                                    "ensureRunning": "true",
                                    "files": [
                                        "C:\\cfn\\cfn-hup.conf",
                                        "C:\\cfn\\hooks.d\\cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        }
                    },
                    "Prep": {
                        "files": {
                            "C:\\cfn\\scripts\\Set-Dns.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Set-Dns.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Join-Domain.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Join-Domain.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Rename-Computer.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Rename-Computer.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Install-WindowsFailoverClustering.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Install-WindowsFailoverClustering.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Install-NETFrameworkCore.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Install-NETFrameworkCore.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\OpenWSFCPorts.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/OpenWSFCPorts.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\EnableCredSsp.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/EnableCredSsp.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\DownloadSQLEE.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/DownloadSQLEE.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Invoke-ADReplication.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Invoke-ADReplication.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-dns": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Set-Dns.ps1 -ns1 '",
                                            {
                                                "Ref": "ADServer1PrivateIP"
                                            },
                                            "' -ns2 '",
                                            {
                                                "Ref": "ADServer2PrivateIP"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "30"
                            },
                            "b-rename-computer": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Rename-Computer.ps1 -Restart -NewName '",
                                            {
                                                "Ref": "WSFCNode2NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            },
                            "c-join-domain": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Join-Domain.ps1 -DomainName '",
                                            {
                                                "Ref": "DomainDNSName"
                                            },
                                            "' -UserName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "\\",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            },
                            "d-install-net-framework-core": {
                                "command": "powershell.exe -Command \"C:\\cfn\\scripts\\Install-NETFrameworkCore.ps1\"",
                                "waitAfterCompletion": "0"
                            },
                            "e-install-windows-failover-clustering": {
                                "command": "powershell.exe -Command \"C:\\cfn\\scripts\\Install-WindowsFailoverClustering.ps1\"",
                                "waitAfterCompletion": "0"
                            },
                            "f-reboot": {
                                "command": "powershell.exe -Command \"Restart-Computer -Force\"",
                                "waitAfterCompletion": "forever"
                            },
                            "g-open-WSFC-ports": {
                                "command": "powershell.exe -ExecutionPolicy RemoteSigned -Command \"C:\\cfn\\scripts\\OpenWSFCPorts.ps1\"",
                                "waitAfterCompletion": "0"
                            },
                            "h-enable-credssp": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -ExecutionPolicy RemoteSigned -Command \"C:\\cfn\\scripts\\EnableCredSsp.ps1",
                                            " -DomainDNSName '",
                                            {
                                                "Ref": "DomainDNSName"
                                            },
                                            "' -ServerName '",
                                            {
                                                "Ref": "WSFCNode2NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "i-Invoke-ADReplication-DC1": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Invoke-ADReplication.ps1",
                                            " -UserName '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -DomainController '",
                                            {
                                                "Ref": "ADServer1NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "j-Invoke-ADReplication-DC2": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Invoke-ADReplication.ps1",
                                            " -UserName '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -Password '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -DomainController '",
                                            {
                                                "Ref": "ADServer2NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "15"
                            },
                            "k-download-sql-installer": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-ExecutionPolicy RemoteSigned ",
                                            "-Command \"",
                                            " C:\\cfn\\scripts\\DownloadSQLEE.ps1 -SQLServerVersion '",
                                            {
                                                "Ref": "SQLServerVersion"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Install": {
                        "files": {
                            "C:\\cfn\\scripts\\InstallSQLEE.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/InstallSQLEE.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-install-sql": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\InstallSQLEE.ps1 -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -SQLServiceAccount '",
                                            {
                                                "Ref": "SQLServiceAccount"
                                            },
                                            "' -SQLServiceAccountPassword '",
                                            {
                                                "Ref": "SQLServiceAccountPassword"
                                            },
                                            "' -NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode2NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "SQLIncludedConfigure": {
                        "files": {
                            "C:\\cfn\\scripts\\Reconfigure-SQL.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Reconfigure-SQL.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-configure-sql": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Reconfigure-SQL.ps1 -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -SQLServiceAccount '",
                                            {
                                                "Ref": "SQLServiceAccount"
                                            },
                                            "' -SQLServiceAccountPassword '",
                                            {
                                                "Ref": "SQLServiceAccountPassword"
                                            },
                                            "' -NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode2NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Configure": {
                        "files": {
                            "C:\\cfn\\scripts\\Invoke-ADReplication.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Invoke-ADReplication.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Create-Share.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/Create-Share.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Set-Folder-Permissions.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Set-Folder-Permissions.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Configure-WSFC.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Configure-WSFC.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Enable-AlwaysOn.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Enable-AlwaysOn.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\Set-ClusterQuorum.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/Set-ClusterQuorum.ps1"
                                        ]
                                    ]
                                }
                            },
                            "C:\\cfn\\scripts\\SetMaxDOP.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "scripts/SetMaxDOP.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-set-maxdop": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\SetMaxDOP.ps1 -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode2NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "b-configure-WSFC": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -ExecutionPolicy RemoteSigned -Command \"C:\\cfn\\scripts\\Configure-WSFC.ps1",
                                            " -WSFCNode1PrivateIP2 ",
                                            {
                                                "Ref": "WSFCNode1PrivateIP2"
                                            },
                                            " -WSFCNode2PrivateIP2 ",
                                            {
                                                "Ref": "WSFCNode2PrivateIP2"
                                            },
                                            {
                                                "Fn::If": [
                                                    "ThirdAzIsFullNode",
                                                    " -WSFCNode3PrivateIP2 ",
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "ThirdAzIsFullNode",
                                                    {
                                                        "Ref": "WSFCNode3PrivateIP2"
                                                    },
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            " -WSFCNode1NetBIOSName ",
                                            {
                                                "Ref": "WSFCNode1NetBIOSName"
                                            },
                                            " -WSFCNode2NetBIOSName ",
                                            {
                                                "Ref": "WSFCNode2NetBIOSName"
                                            },
                                            {
                                                "Fn::If": [
                                                    "ThirdAzIsFullNode",
                                                    " -WSFCNode3NetBIOSName ",
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "ThirdAzIsFullNode",
                                                    {
                                                        "Ref": "WSFCNode3NetBIOSName"
                                                    },
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            " -DomainNetBIOSName ",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            " -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode2NetBIOSName"
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "c-create-witness-share": {
                                "Fn::If": [
                                    "IsTwoNode",
                                    {
                                        "command": {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "powershell.exe -Command \"C:\\cfn\\scripts\\Create-Share.ps1",
                                                    " -Path 'c:\\witness'",
                                                    " -ShareName 'witness'",
                                                    " -FolderPath 'c:\\'",
                                                    " -FolderName 'witness'",
                                                    " -DomainNetBIOSName '",
                                                    {
                                                        "Ref": "DomainNetBIOSName"
                                                    },
                                                    "' -DomainAdminUser '",
                                                    {
                                                        "Ref": "DomainAdminUser"
                                                    },
                                                    "' -DomainAdminPassword '",
                                                    {
                                                        "Ref": "DomainAdminPassword"
                                                    },
                                                    "' -ServerName '",
                                                    {
                                                        "Ref": "WSFCFileServerNetBIOSName"
                                                    },
                                                    "'\""
                                                ]
                                            ]
                                        },
                                        "waitAfterCompletion": "0"
                                    },
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            },
                            "d-create-Replica-share": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command \"C:\\cfn\\scripts\\Create-Share.ps1",
                                            " -Path 'c:\\replica'",
                                            " -ShareName 'replica'",
                                            " -FolderPath 'c:\\'",
                                            " -FolderName 'replica'",
                                            " -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -ServerName '",
                                            {
                                                "Fn::If": [
                                                    "IsTwoNode",
                                                    {
                                                        "Ref": "WSFCFileServerNetBIOSName"
                                                    },
                                                    {
                                                        "Ref": "WSFCNode1NetBIOSName"
                                                    }
                                                ]
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "e-Invoke-ADReplication-DC1": {
                                "Fn::If": [
                                    "IsTwoNode",
                                    {
                                        "command": {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "powershell.exe -Command \"C:\\cfn\\scripts\\Invoke-ADReplication.ps1",
                                                    " -UserName '",
                                                    {
                                                        "Ref": "DomainAdminUser"
                                                    },
                                                    "' -Password '",
                                                    {
                                                        "Ref": "DomainAdminPassword"
                                                    },
                                                    "' -DomainController '",
                                                    {
                                                        "Ref": "ADServer1NetBIOSName"
                                                    },
                                                    "'\""
                                                ]
                                            ]
                                        },
                                        "waitAfterCompletion": "0"
                                    },
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            },
                            "f-Invoke-ADReplication-DC2": {
                                "Fn::If": [
                                    "IsTwoNode",
                                    {
                                        "command": {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "powershell.exe -Command \"C:\\cfn\\scripts\\Invoke-ADReplication.ps1",
                                                    " -UserName '",
                                                    {
                                                        "Ref": "DomainAdminUser"
                                                    },
                                                    "' -Password '",
                                                    {
                                                        "Ref": "DomainAdminPassword"
                                                    },
                                                    "' -DomainController '",
                                                    {
                                                        "Ref": "ADServer2NetBIOSName"
                                                    },
                                                    "'\""
                                                ]
                                            ]
                                        },
                                        "waitAfterCompletion": "0"
                                    },
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            },
                            "g-Set-Folder-Permissions": {
                                "Fn::If": [
                                    "IsTwoNode",
                                    {
                                        "command": {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "powershell.exe -ExecutionPolicy RemoteSigned \"C:\\cfn\\scripts\\Set-Folder-Permissions.ps1",
                                                    " -DomainNetBIOSName '",
                                                    {
                                                        "Ref": "DomainNetBIOSName"
                                                    },
                                                    "' -DomainAdminUser '",
                                                    {
                                                        "Ref": "DomainAdminUser"
                                                    },
                                                    "' -DomainAdminPassword '",
                                                    {
                                                        "Ref": "DomainAdminPassword"
                                                    },
                                                    "' -SQLServiceAccount '",
                                                    {
                                                        "Ref": "SQLServiceAccount"
                                                    },
                                                    "' -FileServerNetBIOSName '",
                                                    {
                                                        "Ref": "WSFCFileServerNetBIOSName"
                                                    },
                                                    "'\""
                                                ]
                                            ]
                                        },
                                        "waitAfterCompletion": "0"
                                    },
                                    {
                                        "Ref": "AWS::NoValue"
                                    }
                                ]
                            },
                            "h-Enable-AlwaysOn": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -ExecutionPolicy RemoteSigned \"C:\\cfn\\scripts\\Enable-AlwaysOn.ps1",
                                            " -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -WSFCNode1NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode1NetBIOSName"
                                            },
                                            "' -WSFCNode2NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode2NetBIOSName"
                                            },
                                            {
                                                "Fn::If": [
                                                    "ThirdAzIsFullNode",
                                                    "' -WSFCNode3NetBIOSName '",
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "ThirdAzIsFullNode",
                                                    {
                                                        "Ref": "WSFCNode3NetBIOSName"
                                                    },
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            },
                            "i-Set-ClusterQuorum": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -ExecutionPolicy RemoteSigned \"C:\\cfn\\scripts\\Set-ClusterQuorum.ps1",
                                            {
                                                "Fn::If": [
                                                    "ThirdAzIsFullNode",
                                                    " -Witness $false",
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            " -DomainNetBIOSName '",
                                            {
                                                "Ref": "DomainNetBIOSName"
                                            },
                                            "' -DomainAdminUser '",
                                            {
                                                "Ref": "DomainAdminUser"
                                            },
                                            "' -DomainAdminPassword '",
                                            {
                                                "Ref": "DomainAdminPassword"
                                            },
                                            "' -WSFCNode2NetBIOSName '",
                                            {
                                                "Ref": "WSFCNode2NetBIOSName"
                                            },
                                            {
                                                "Fn::If": [
                                                    "IsTwoNode",
                                                    "' -FileServerNetBIOSName '",
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            {
                                                "Fn::If": [
                                                    "IsTwoNode",
                                                    {
                                                        "Ref": "WSFCFileServerNetBIOSName"
                                                    },
                                                    {
                                                        "Ref": "AWS::NoValue"
                                                    }
                                                ]
                                            },
                                            "'\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Cleanup": {
                        "files": {
                            "C:\\cfn\\scripts\\DisableCredSsp.ps1": {
                                "source": {
                                    "Fn::Join": [
                                        "/",
                                        [
                                            {
                                                "Fn::FindInMap": [
                                                    "AWSInfoRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "QuickStartS3URL"
                                                ]
                                            },
                                            {
                                                "Ref": "QSS3BucketName"
                                            },
                                            {
                                                "Ref": "QSS3KeyPrefix"
                                            },
                                            "submodules/quickstart-microsoft-utilities",
                                            "scripts/DisableCredSsp.ps1"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "a-disable-credssp": {
                                "command": "powershell.exe -ExecutionPolicy RemoteSigned \"C:\\cfn\\scripts\\DisableCredSsp.ps1\"",
                                "waitAfterCompletion": "0"
                            }
                        }
                    },
                    "Finalize": {
                        "commands": {
                            "a-reboot": {
                                "command": "powershell.exe -Command \"Restart-Computer -Force\"",
                                "waitAfterCompletion": "forever"
                            },
                            "b-signal-success": {
                                "command": "powershell -Command \"Write-AWSQuickStartStatus\""
                            }
                        }
                    }
                }
            },
            "Properties": {
                "Affinity": {
                    "Fn::If": [
                        "HostTypeIsDediHost",
                        "host",
                        {
                            "Fn::If": [
                                "HostTypeIsDefault",
                                {
                                    "Ref": "AWS::NoValue"
                                },
                                "default"
                            ]
                        }
                    ]
                },
                "HostId": {
                    "Fn::If": [
                        "HostTypeIsDediHost",
                        {
                            "Ref": "DedicatedHostIDNode2"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Tenancy": {
                    "Fn::If": [
                        "HostTypeIsDediHost",
                        "host",
                        {
                            "Fn::If": [
                                "HostTypeIsDefault",
                                "default",
                                "dedicated"
                            ]
                        }
                    ]
                },
                "ImageId": {
                    "Fn::If": [
                        "ByolAmi",
                        {
                            "Ref": "DedicatedHostAMI"
                        },
                        {
                            "Fn::FindInMap": [
                                "AWSAMIRegionMap",
                                {
                                    "Ref": "AWS::Region"
                                },
                                {
                                    "Fn::FindInMap": [
                                        "SQLAMINameMap",
                                        {
                                            "Ref": "SQLServerVersion"
                                        },
                                        {
                                            "Ref": "SQLLicenseProvided"
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "InstanceType": {
                    "Ref": "WSFCNode2InstanceType"
                },
                "EbsOptimized": "true",
                "NetworkInterfaces": [
                    {
                        "DeleteOnTermination": "true",
                        "DeviceIndex": 0,
                        "SubnetId": {
                            "Ref": "PrivateSubnet2ID"
                        },
                        "PrivateIpAddresses": [
                            {
                                "Primary": "true",
                                "PrivateIpAddress": {
                                    "Ref": "WSFCNode2PrivateIP1"
                                }
                            },
                            {
                                "Primary": "false",
                                "PrivateIpAddress": {
                                    "Ref": "WSFCNode2PrivateIP2"
                                }
                            },
                            {
                                "Primary": "false",
                                "PrivateIpAddress": {
                                    "Ref": "WSFCNode2PrivateIP3"
                                }
                            }
                        ],
                        "GroupSet": [
                            {
                                "Ref": "DomainMemberSGID"
                            },
                            {
                                "Ref": "WSFCSecurityGroup"
                            },
                            {
                                "Ref": "WSFCClientSecurityGroup"
                            }
                        ]
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "WSFCNode2NetBIOSName"
                        }
                    }
                ],
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "100",
                            "VolumeType": "gp2"
                        }
                    },
                    {
                        "DeviceName": "/dev/xvdca",
                        "VirtualName": "ephemeral0"
                    }
                ],
                "KeyName": {
                    "Ref": "KeyPairName"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "<script>\n",
                                "cfn-init.exe -v -c config -s ",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                " -r WSFCNode2 ",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "</script>"
                            ]
                        ]
                    }
                }
            }
        },
        "WSFCNode1Volume1": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "Size": {
                    "Ref": "Volume1Size"
                },
                "VolumeType": {
                    "Ref": "Volume1Type"
                },
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "WSFCNode1",
                        "AvailabilityZone"
                    ]
                },
                "Iops": {
                    "Fn::If": [
                        "Vol1IsIo1",
                        {
                            "Ref": "Volume1Iops"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "WSFCNode1Volume2": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "Size": {
                    "Ref": "Volume2Size"
                },
                "VolumeType": {
                    "Ref": "Volume2Type"
                },
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "WSFCNode1",
                        "AvailabilityZone"
                    ]
                },
                "Iops": {
                    "Fn::If": [
                        "Vol2IsIo1",
                        {
                            "Ref": "Volume2Iops"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "WSFCNode1Volume3": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "Size": {
                    "Ref": "Volume3Size"
                },
                "VolumeType": {
                    "Ref": "Volume3Type"
                },
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "WSFCNode1",
                        "AvailabilityZone"
                    ]
                },
                "Iops": {
                    "Fn::If": [
                        "Vol3IsIo1",
                        {
                            "Ref": "Volume3Iops"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "WSFCNode2Volume1": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "Size": {
                    "Ref": "Volume1Size"
                },
                "VolumeType": {
                    "Ref": "Volume1Type"
                },
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "WSFCNode2",
                        "AvailabilityZone"
                    ]
                },
                "Iops": {
                    "Fn::If": [
                        "Vol1IsIo1",
                        {
                            "Ref": "Volume1Iops"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "WSFCNode2Volume2": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "Size": {
                    "Ref": "Volume2Size"
                },
                "VolumeType": {
                    "Ref": "Volume2Type"
                },
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "WSFCNode2",
                        "AvailabilityZone"
                    ]
                },
                "Iops": {
                    "Fn::If": [
                        "Vol2IsIo1",
                        {
                            "Ref": "Volume2Iops"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "WSFCNode2Volume3": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "Size": {
                    "Ref": "Volume3Size"
                },
                "VolumeType": {
                    "Ref": "Volume3Type"
                },
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "WSFCNode2",
                        "AvailabilityZone"
                    ]
                },
                "Iops": {
                    "Fn::If": [
                        "Vol3IsIo1",
                        {
                            "Ref": "Volume3Iops"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "WSFCNode3Volume1": {
            "Type": "AWS::EC2::Volume",
            "Condition": "ThirdAzIsFullNode",
            "Properties": {
                "Size": {
                    "Ref": "Volume1Size"
                },
                "VolumeType": {
                    "Ref": "Volume1Type"
                },
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "WSFCNode3",
                        "AvailabilityZone"
                    ]
                },
                "Iops": {
                    "Fn::If": [
                        "Vol1IsIo1",
                        {
                            "Ref": "Volume1Iops"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "WSFCNode3Volume2": {
            "Type": "AWS::EC2::Volume",
            "Condition": "ThirdAzIsFullNode",
            "Properties": {
                "Size": {
                    "Ref": "Volume2Size"
                },
                "VolumeType": {
                    "Ref": "Volume2Type"
                },
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "WSFCNode3",
                        "AvailabilityZone"
                    ]
                },
                "Iops": {
                    "Fn::If": [
                        "Vol2IsIo1",
                        {
                            "Ref": "Volume2Iops"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "WSFCNode3Volume3": {
            "Type": "AWS::EC2::Volume",
            "Condition": "ThirdAzIsFullNode",
            "Properties": {
                "Size": {
                    "Ref": "Volume3Size"
                },
                "VolumeType": {
                    "Ref": "Volume3Type"
                },
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "WSFCNode3",
                        "AvailabilityZone"
                    ]
                },
                "Iops": {
                    "Fn::If": [
                        "Vol3IsIo1",
                        {
                            "Ref": "Volume3Iops"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "WSFCNode1Volume1Attachment": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Properties": {
                "Device": "/dev/xvdb",
                "InstanceId": {
                    "Ref": "WSFCNode1"
                },
                "VolumeId": {
                    "Ref": "WSFCNode1Volume1"
                }
            }
        },
        "WSFCNode1Volume2Attachment": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Properties": {
                "Device": "/dev/xvdc",
                "InstanceId": {
                    "Ref": "WSFCNode1"
                },
                "VolumeId": {
                    "Ref": "WSFCNode1Volume2"
                }
            }
        },
        "WSFCNode1Volume3Attachment": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Properties": {
                "Device": "/dev/xvdd",
                "InstanceId": {
                    "Ref": "WSFCNode1"
                },
                "VolumeId": {
                    "Ref": "WSFCNode1Volume3"
                }
            }
        },
        "WSFCNode2Volume1Attachment": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Properties": {
                "Device": "/dev/xvdb",
                "InstanceId": {
                    "Ref": "WSFCNode2"
                },
                "VolumeId": {
                    "Ref": "WSFCNode2Volume1"
                }
            }
        },
        "WSFCNode2Volume2Attachment": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Properties": {
                "Device": "/dev/xvdc",
                "InstanceId": {
                    "Ref": "WSFCNode2"
                },
                "VolumeId": {
                    "Ref": "WSFCNode2Volume2"
                }
            }
        },
        "WSFCNode2Volume3Attachment": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Properties": {
                "Device": "/dev/xvdd",
                "InstanceId": {
                    "Ref": "WSFCNode2"
                },
                "VolumeId": {
                    "Ref": "WSFCNode2Volume3"
                }
            }
        },
        "WSFCNode3Volume1Attachment": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Condition": "ThirdAzIsFullNode",
            "Properties": {
                "Device": "/dev/xvdb",
                "InstanceId": {
                    "Ref": "WSFCNode3"
                },
                "VolumeId": {
                    "Ref": "WSFCNode3Volume1"
                }
            }
        },
        "WSFCNode3Volume2Attachment": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Condition": "ThirdAzIsFullNode",
            "Properties": {
                "Device": "/dev/xvdc",
                "InstanceId": {
                    "Ref": "WSFCNode3"
                },
                "VolumeId": {
                    "Ref": "WSFCNode3Volume2"
                }
            }
        },
        "WSFCNode3Volume3Attachment": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Condition": "ThirdAzIsFullNode",
            "Properties": {
                "Device": "/dev/xvdd",
                "InstanceId": {
                    "Ref": "WSFCNode3"
                },
                "VolumeId": {
                    "Ref": "WSFCNode3Volume3"
                }
            }
        },
        "WSFCSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable the WSFC and SQL AlwaysOn Availability Group communications",
                "VpcId": {
                    "Ref": "VPCID"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "icmp",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "icmp",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "icmp",
                                "FromPort": "-1",
                                "ToPort": "-1",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "135",
                        "ToPort": "135",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "135",
                        "ToPort": "135",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "135",
                                "ToPort": "135",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "137",
                        "ToPort": "137",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "137",
                        "ToPort": "137",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "137",
                                "ToPort": "137",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "445",
                        "ToPort": "445",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "445",
                        "ToPort": "445",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "445",
                                "ToPort": "445",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1433",
                        "ToPort": "1433",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1433",
                        "ToPort": "1433",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "1433",
                                "ToPort": "1433",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "3343",
                        "ToPort": "3343",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "3343",
                        "ToPort": "3343",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "3343",
                                "ToPort": "3343",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "5022",
                        "ToPort": "5022",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "5022",
                        "ToPort": "5022",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "5022",
                                "ToPort": "5022",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "5985",
                        "ToPort": "5985",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "5985",
                        "ToPort": "5985",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "5985",
                                "ToPort": "5985",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "49152",
                        "ToPort": "65535",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "49152",
                        "ToPort": "65535",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "49152",
                                "ToPort": "65535",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "udp",
                        "FromPort": "137",
                        "ToPort": "137",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "udp",
                        "FromPort": "137",
                        "ToPort": "137",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "udp",
                                "FromPort": "137",
                                "ToPort": "137",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "udp",
                        "FromPort": "3343",
                        "ToPort": "3343",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "udp",
                        "FromPort": "3343",
                        "ToPort": "3343",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "udp",
                                "FromPort": "3343",
                                "ToPort": "3343",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "udp",
                        "FromPort": "49152",
                        "ToPort": "65535",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "udp",
                        "FromPort": "49152",
                        "ToPort": "65535",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "udp",
                                "FromPort": "49152",
                                "ToPort": "65535",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1433",
                        "ToPort": "1434",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1433",
                        "ToPort": "1434",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "1433",
                                "ToPort": "1434",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1433",
                        "ToPort": "1434",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1433",
                        "ToPort": "1434",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "IsThreeAz",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "1433",
                                "ToPort": "1434",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    }
                ]
            }
        },
        "WSFCClientSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable SQL Client Connections from instances inside the VPC",
                "VpcId": {
                    "Ref": "VPCID"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1433",
                        "ToPort": "1433",
                        "CidrIp": {
                            "Ref": "PrivateSubnet1CIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1433",
                        "ToPort": "1433",
                        "CidrIp": {
                            "Ref": "PrivateSubnet2CIDR"
                        }
                    },
                    {
                        "Fn::If": [
                            "ThirdAzIsFullNode",
                            {
                                "IpProtocol": "tcp",
                                "FromPort": "1433",
                                "ToPort": "1433",
                                "CidrIp": {
                                    "Ref": "PrivateSubnet3CIDR"
                                }
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    }
                ]
            }
        }
    },
    "Outputs": {
        "DomainAdmin": {
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        {
                            "Ref": "DomainNetBIOSName"
                        },
                        "\\",
                        {
                            "Ref": "DomainAdminUser"
                        }
                    ]
                ]
            },
            "Description": "Domain administrator account"
        },
        "LocalAdmin": {
            "Value": "Administrator",
            "Description": "Please retrieve Administrator password of the instance"
        },
        "WSFCNode1NetBIOSName": {
            "Value": {
                "Ref": "WSFCNode1NetBIOSName"
            },
            "Description": "NetBIOS name of the 1st WSFC Node"
        },
        "WSFCNode2NetBIOSName": {
            "Value": {
                "Ref": "WSFCNode2NetBIOSName"
            },
            "Description": "NetBIOS name of the 2nd WSFC Node"
        },
        "WSFCNode3NetBIOSName": {
            "Condition": "ThirdAzIsFullNode",
            "Value": {
                "Ref": "WSFCNode3NetBIOSName"
            },
            "Description": "NetBIOS name of the 3rd WSFC Node"
        }
    }
}
